<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ìˆ˜í•™ í€´ì¦ˆ ëŒ€ê²°</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#1a1a2e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="/icons/icon-192.svg">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #1a1a2e;
      --card: #16213e;
      --accent: #e94560;
      --accent2: #0f3460;
      --gold: #f5c518;
      --text: #eee;
      --green: #4ecca3;
      --purple: #6c5ce7;
    }

    body {
      font-family: 'Segoe UI', 'Apple SD Gothic Neo', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow-x: hidden;
    }

    .screen { display: none; width: 100%; max-width: 500px; padding: 16px; }
    .screen.active { display: flex; flex-direction: column; align-items: center; }

    h1 { font-size: 1.8rem; margin: 16px 0 8px; text-align: center; }

    input[type="text"] {
      width: 100%; max-width: 320px; padding: 14px; margin: 8px 0;
      border: 2px solid #333; border-radius: 12px; font-size: 1.1rem;
      text-align: center; background: #0d1b2a; color: #fff; outline: none;
    }
    input[type="text"]:focus { border-color: var(--purple); }
    input[type="text"]::placeholder { color: #666; }

    .lobby-btn {
      width: 100%; max-width: 320px; padding: 18px; margin: 8px 0;
      border: none; border-radius: 16px; font-size: 1.2rem; font-weight: 700;
      cursor: pointer; transition: transform 0.15s;
    }
    .lobby-btn:active { transform: scale(0.96); }
    .btn-create { background: var(--purple); color: #fff; }
    .btn-join { background: var(--accent2); color: #fff; }

    .sub-text { color: #888; font-size: 0.85rem; margin: 4px 0; }
    .info-text { color: #888; font-size: 0.95rem; margin: 8px 0; text-align: center; }

    .back-btn {
      background: none; border: 1px solid #555; color: #aaa;
      padding: 8px 20px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; margin: 8px 0;
      text-decoration: none; display: inline-block; text-align: center;
    }

    /* ì´ëª¨ì§€ ì„ íƒ */
    .emoji-grid {
      display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; margin: 8px 0;
    }
    .emoji-btn {
      width: 48px; height: 48px; border-radius: 12px; border: 3px solid transparent;
      font-size: 1.5rem; cursor: pointer; transition: all 0.2s;
      display: flex; align-items: center; justify-content: center; background: var(--card);
    }
    .emoji-btn.active { border-color: var(--gold); background: rgba(245,197,24,0.15); transform: scale(1.15); }

    /* ì„¤ì • ë²„íŠ¼ */
    .opt-selector { display: flex; gap: 8px; justify-content: center; margin: 8px 0; }
    .opt-btn {
      padding: 10px 16px; border: 2px solid #333; border-radius: 10px;
      background: var(--card); color: var(--text); font-size: 0.9rem; font-weight: 700;
      cursor: pointer; transition: all 0.2s;
    }
    .opt-btn.active { border-color: var(--purple); background: rgba(108,92,231,0.15); color: var(--purple); }

    /* ëŒ€ê¸°ì‹¤ */
    .room-code {
      font-size: 2.5rem; font-weight: 900; letter-spacing: 8px; color: var(--gold);
      background: rgba(245,197,24,0.1); padding: 12px 32px; border-radius: 16px; margin: 12px 0;
    }

    .player-card {
      display: flex; align-items: center; gap: 12px; padding: 12px 16px;
      background: var(--card); border-radius: 12px; margin: 4px 0;
      width: 100%; max-width: 320px;
    }
    .player-card .p-emoji { font-size: 1.6rem; }
    .player-card .p-name { font-size: 1.1rem; font-weight: 700; flex: 1; }
    .player-card .p-host { font-size: 0.75rem; color: var(--gold); background: rgba(245,197,24,0.15); padding: 2px 8px; border-radius: 8px; }

    .btn-start {
      margin-top: 16px; padding: 16px 48px; background: var(--green); color: #000;
      font-weight: 800; font-size: 1.2rem; border: none; border-radius: 14px; cursor: pointer;
    }

    /* ì¹´ìš´íŠ¸ë‹¤ìš´ */
    .countdown {
      font-size: 5rem; font-weight: 900; color: var(--accent);
      animation: cdPulse 0.5s infinite;
    }
    @keyframes cdPulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.3); } }

    /* ê²Œì„ í™”ë©´ */
    .scoreboard { display: flex; gap: 8px; justify-content: center; margin: 8px 0; flex-wrap: wrap; }
    .score-item {
      display: flex; flex-direction: column; align-items: center; gap: 2px;
      padding: 8px 12px; border-radius: 12px; background: var(--card); min-width: 70px;
    }
    .score-item.me { border: 2px solid var(--gold); }
    .score-emoji { font-size: 1.3rem; }
    .score-name { font-size: 0.75rem; color: #aaa; }
    .score-pts { font-size: 1.3rem; font-weight: 900; color: var(--gold); }

    .round-indicator {
      text-align: center; font-size: 0.9rem; font-weight: 700; color: #888;
      background: rgba(255,255,255,0.05); padding: 6px 16px; border-radius: 20px; margin: 8px 0;
    }

    .problem-box {
      display: flex; align-items: center; justify-content: center; gap: 12px;
      padding: 24px; background: rgba(108,92,231,0.1); border-radius: 20px; margin: 16px 0;
    }
    .problem-num { font-size: 2.8rem; font-weight: 900; }
    .problem-op { font-size: 2.2rem; font-weight: 700; color: var(--purple); }

    .choices-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 16px 0; width: 100%; max-width: 320px; }
    .choice-btn {
      padding: 20px; border: none; border-radius: 16px; font-size: 1.8rem; font-weight: 800;
      cursor: pointer; transition: all 0.15s; color: #fff;
      box-shadow: 0 3px 8px rgba(0,0,0,0.2);
    }
    .choice-btn:active { transform: scale(0.93); }
    .choice-btn:disabled { cursor: default; opacity: 0.5; }
    .choice-btn.correct { background: var(--green) !important; opacity: 1 !important; }
    .choice-btn.wrong { background: var(--accent) !important; opacity: 1 !important; }

    /* ë¼ìš´ë“œ ê²°ê³¼ */
    .result-box {
      padding: 20px; background: rgba(108,92,231,0.1); border-radius: 20px; margin: 16px 0;
      text-align: center; width: 100%; max-width: 360px;
    }
    .result-answer { font-size: 1.4rem; margin-bottom: 12px; }
    .result-winner { font-size: 2.5rem; margin-bottom: 4px; }
    .result-winner-name { font-size: 1.2rem; font-weight: 700; }
    .result-player-answer {
      display: flex; align-items: center; justify-content: center; gap: 8px;
      padding: 6px 0; font-size: 1rem;
    }

    /* ìµœì¢… ê²°ê³¼ */
    .final-card {
      display: flex; align-items: center; gap: 12px; padding: 14px 16px;
      border-radius: 16px; margin-bottom: 8px; width: 100%; max-width: 360px;
    }
    .final-card.winner { background: rgba(245,197,24,0.15); border: 2px solid var(--gold); transform: scale(1.03); }
    .final-card:not(.winner) { background: var(--card); }
    .final-medal { font-size: 1.5rem; }
    .final-emoji { font-size: 1.8rem; }
    .final-info { flex: 1; }
    .final-name { font-weight: 700; font-size: 1.1rem; }
    .final-detail { color: #888; font-size: 0.85rem; }
    .final-score { font-weight: 900; font-size: 1.8rem; }

    .btn-primary {
      width: 100%; max-width: 320px; padding: 16px; background: var(--purple); color: #fff;
      border: none; border-radius: 14px; font-size: 1.1rem; font-weight: 800;
      cursor: pointer; margin-top: 16px;
    }

    /* í† ìŠ¤íŠ¸ */
    .toast {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: var(--accent); color: #fff; padding: 12px 24px; border-radius: 12px;
      font-weight: 600; z-index: 200;
      animation: toastIn 0.3s, toastOut 0.3s 2s forwards;
    }
    @keyframes toastIn { from { opacity: 0; transform: translateX(-50%) translateY(20px); } }
    @keyframes toastOut { to { opacity: 0; transform: translateX(-50%) translateY(20px); } }

    /* ê½ƒê°€ë£¨ */
    @keyframes confettiFall {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }

    @media (max-width: 360px) {
      .problem-num { font-size: 2rem; }
      .choice-btn { font-size: 1.4rem; padding: 16px; }
    }
  </style>
</head>
<body>

  <!-- ë¡œë¹„ -->
  <div id="screen-lobby" class="screen active">
    <h1>ğŸ§® ìˆ˜í•™ í€´ì¦ˆ ëŒ€ê²°</h1>
    <p class="sub-text">ê°€ì¡±ê³¼ í•¨ê»˜ ë§ì…ˆ ëº„ì…ˆ ì†ë„ ëŒ€ê²°!</p>

    <input type="text" id="input-name" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="8">

    <p style="color:#aaa; font-size:0.9rem; margin-top:8px;">ìºë¦­í„° ì„ íƒ</p>
    <div class="emoji-grid" id="emoji-grid"></div>

    <button class="lobby-btn btn-create" onclick="createRoom()">ğŸ® ë°© ë§Œë“¤ê¸°</button>

    <div style="display:flex; gap:8px; width:100%; max-width:320px; align-items:center; margin:4px 0;">
      <input type="text" id="input-code" placeholder="ë°© ì½”ë“œ" maxlength="4"
             style="flex:1; text-transform:uppercase; letter-spacing:4px; font-weight:700;">
      <button class="lobby-btn btn-join" onclick="joinRoom()"
              style="width:auto; flex:0 0 auto; padding:14px 24px;">ì°¸ê°€</button>
    </div>
    <a href="/" class="back-btn">ğŸ  í™ˆìœ¼ë¡œ</a>
  </div>

  <!-- ëŒ€ê¸°ì‹¤ -->
  <div id="screen-waiting" class="screen">
    <h1>ğŸ§® ëŒ€ê¸°ì‹¤</h1>
    <p class="info-text">ì•„ë˜ ì½”ë“œë¥¼ ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ì…ë ¥í•˜ì„¸ìš”!</p>
    <div class="room-code" id="display-code">----</div>

    <!-- ë‚œì´ë„ ì„ íƒ -->
    <div id="difficulty-host" style="display:none; margin:8px 0; text-align:center;">
      <p style="color:#aaa; font-size:0.9rem; margin-bottom:6px;">ë‚œì´ë„</p>
      <div class="opt-selector">
        <button class="opt-btn active" data-diff="easy" onclick="setDifficulty('easy')">ì‰¬ì›€<br><span style="font-size:0.7rem;color:#888">1~10 ë§ì…ˆ</span></button>
        <button class="opt-btn" data-diff="normal" onclick="setDifficulty('normal')">ë³´í†µ<br><span style="font-size:0.7rem;color:#888">1~20 ë§ëº„ì…ˆ</span></button>
        <button class="opt-btn" data-diff="hard" onclick="setDifficulty('hard')">ì–´ë ¤ì›€<br><span style="font-size:0.7rem;color:#888">1~50 ë§ëº„ì…ˆ</span></button>
      </div>
    </div>

    <!-- ë¼ìš´ë“œ ìˆ˜ -->
    <div id="rounds-host" style="display:none; margin:8px 0; text-align:center;">
      <p style="color:#aaa; font-size:0.9rem; margin-bottom:6px;">ë¼ìš´ë“œ ìˆ˜</p>
      <div class="opt-selector">
        <button class="opt-btn" data-rounds="5" onclick="setRounds(5)">5íŒ</button>
        <button class="opt-btn active" data-rounds="10" onclick="setRounds(10)">10íŒ</button>
        <button class="opt-btn" data-rounds="15" onclick="setRounds(15)">15íŒ</button>
        <button class="opt-btn" data-rounds="20" onclick="setRounds(20)">20íŒ</button>
      </div>
    </div>

    <!-- ì„¤ì • í‘œì‹œ (ë¹„ë°©ì¥) -->
    <p id="settings-guest" class="info-text" style="display:none;"></p>

    <div id="player-list" style="width:100%; max-width:320px;"></div>

    <button class="btn-start" id="btn-start" style="display:none" onclick="startGame()">ê²Œì„ ì‹œì‘! ğŸš€</button>
    <p class="info-text" id="waiting-msg">ë°©ì¥ì´ ê²Œì„ì„ ì‹œì‘í•  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>
    <button class="back-btn" onclick="leaveRoom()">ë‚˜ê°€ê¸°</button>
    <a href="/" class="back-btn" style="margin-top:4px;">ğŸ  í™ˆìœ¼ë¡œ</a>
  </div>

  <!-- ì¹´ìš´íŠ¸ë‹¤ìš´ -->
  <div id="screen-countdown" class="screen">
    <div style="text-align:center; padding:60px 0;">
      <div class="countdown" id="countdown-num">3</div>
      <p style="font-size:1.2rem; color:#888; margin-top:16px;">ê²Œì„ ì‹œì‘!</p>
    </div>
  </div>

  <!-- ê²Œì„ í™”ë©´ -->
  <div id="screen-game" class="screen">
    <div class="scoreboard" id="scoreboard"></div>
    <div class="round-indicator" id="round-indicator">1 / 10 ë¼ìš´ë“œ</div>

    <!-- ë¬¸ì œ -->
    <div id="problem-area" style="width:100%; display:flex; flex-direction:column; align-items:center;">
      <div class="problem-box" id="problem-box"></div>
      <div class="choices-grid" id="choices-grid"></div>
      <p id="waiting-answer" style="display:none; color:#888; margin-top:12px;">ë‹¤ë¥¸ í”Œë ˆì´ì–´ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</p>
    </div>

    <!-- ë¼ìš´ë“œ ê²°ê³¼ -->
    <div id="round-result" style="display:none; width:100%; display:none; flex-direction:column; align-items:center;">
      <div class="result-box" id="result-box"></div>
      <button class="btn-primary" id="btn-next" style="display:none;" onclick="nextRound()">ë‹¤ìŒ ë¬¸ì œ â¡ï¸</button>
      <p id="waiting-next" class="info-text" style="display:none;">ë°©ì¥ì´ ë‹¤ìŒ ë¬¸ì œë¥¼ ë‚´ë©´ ì‹œì‘ë¼ìš”...</p>
    </div>
  </div>

  <!-- ìµœì¢… ê²°ê³¼ -->
  <div id="screen-result" class="screen">
    <h1 style="font-size:3rem; margin-bottom:0;">ğŸ†</h1>
    <h1>ê²Œì„ ê²°ê³¼!</h1>
    <div id="final-list" style="width:100%; max-width:360px; margin-top:16px;"></div>
    <button class="btn-primary" id="btn-play-again" style="display:none;" onclick="playAgain()">ğŸ”„ ë‹¤ì‹œ í•˜ê¸°</button>
    <a href="/" class="back-btn" style="margin-top:8px;">ğŸ  í™ˆìœ¼ë¡œ</a>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    const EMOJIS = ['ğŸ¦','ğŸ¯','ğŸ»','ğŸ¼','ğŸ¦Š','ğŸ¸','ğŸµ','ğŸ°','ğŸ¶','ğŸ±'];
    const CHOICE_COLORS = ['#e94560','#4ecca3','#f5c518','#6c5ce7'];
    const DIFF_LABELS = { easy: 'ì‰¬ì›€ (1~10)', normal: 'ë³´í†µ (1~20)', hard: 'ì–´ë ¤ì›€ (1~50)' };

    let playerId = localStorage.getItem('quiz-player-id') || null;
    let savedRoomCode = localStorage.getItem('quiz-room-code') || null;
    let savedPlayerName = localStorage.getItem('quiz-player-name') || null;
    let selectedEmoji = EMOJIS[Math.floor(Math.random() * EMOJIS.length)];
    let isHost = false;
    let gameActive = false;
    let myAnswer = null;
    let currentPlayers = [];
    let totalRounds = 10;

    // ì´ëª¨ì§€ ê·¸ë¦¬ë“œ ìƒì„±
    const emojiGrid = document.getElementById('emoji-grid');
    EMOJIS.forEach(e => {
      const btn = document.createElement('button');
      btn.className = 'emoji-btn' + (e === selectedEmoji ? ' active' : '');
      btn.textContent = e;
      btn.onclick = () => {
        selectedEmoji = e;
        document.querySelectorAll('.emoji-btn').forEach(b => b.classList.toggle('active', b.textContent === e));
      };
      emojiGrid.appendChild(btn);
    });

    // Web Audio
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    let audioCtx = null;
    function getAudioCtx() {
      if (!audioCtx) audioCtx = new AudioCtx();
      if (audioCtx.state === 'suspended') audioCtx.resume();
      return audioCtx;
    }
    function playCorrect() {
      const ctx = getAudioCtx(); const t = ctx.currentTime;
      [523,659,784].forEach((f,i) => {
        const o = ctx.createOscillator(), g = ctx.createGain();
        o.connect(g); g.connect(ctx.destination); o.type='sine';
        o.frequency.setValueAtTime(f, t+i*0.1);
        g.gain.setValueAtTime(0.25, t+i*0.1);
        g.gain.exponentialRampToValueAtTime(0.01, t+i*0.1+0.2);
        o.start(t+i*0.1); o.stop(t+i*0.1+0.2);
      });
    }
    function playWrong() {
      const ctx = getAudioCtx(); const t = ctx.currentTime;
      const o = ctx.createOscillator(), g = ctx.createGain();
      o.connect(g); g.connect(ctx.destination); o.type='square';
      o.frequency.setValueAtTime(200, t);
      g.gain.setValueAtTime(0.15, t);
      g.gain.exponentialRampToValueAtTime(0.01, t+0.3);
      o.start(t); o.stop(t+0.3);
    }
    function playFanfare() {
      const ctx = getAudioCtx(); const t = ctx.currentTime;
      [[523,659,784],[587,740,880],[523,659,784,1047]].forEach((chord,ci) => {
        chord.forEach(f => {
          const o = ctx.createOscillator(), g = ctx.createGain();
          o.connect(g); g.connect(ctx.destination); o.type='sine';
          o.frequency.setValueAtTime(f, t+ci*0.3);
          g.gain.setValueAtTime(0.15, t+ci*0.3);
          g.gain.exponentialRampToValueAtTime(0.01, t+ci*0.3+0.5);
          o.start(t+ci*0.3); o.stop(t+ci*0.3+0.5);
        });
      });
    }

    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    function showToast(msg) {
      const t = document.createElement('div');
      t.className = 'toast'; t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 2500);
    }

    function escHtml(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

    // ë¡œë¹„ í•¨ìˆ˜
    function createRoom() {
      const name = document.getElementById('input-name').value.trim();
      if (!name) { showToast('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }
      getAudioCtx(); isHost = true;
      socket.emit('quiz:create-room', { playerName: name, playerId, emoji: selectedEmoji });
    }

    function joinRoom() {
      const name = document.getElementById('input-name').value.trim();
      const code = document.getElementById('input-code').value.trim().toUpperCase();
      if (!name) { showToast('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }
      if (!code || code.length < 4) { showToast('ë°© ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }
      getAudioCtx();
      socket.emit('quiz:join-room', { code, playerName: name, playerId, emoji: selectedEmoji });
    }

    function leaveRoom() { localStorage.removeItem('quiz-room-code'); location.reload(); }
    function startGame() { socket.emit('quiz:start-game'); }
    function setDifficulty(d) { socket.emit('quiz:set-difficulty', d); }
    function setRounds(r) { socket.emit('quiz:set-rounds', r); }
    function nextRound() { socket.emit('quiz:next-round'); }
    function playAgain() { socket.emit('quiz:play-again'); }

    function submitAnswer(choice) {
      if (myAnswer !== null) return;
      myAnswer = choice;
      socket.emit('quiz:submit-answer', choice);
      document.getElementById('waiting-answer').style.display = 'block';
      // ë²„íŠ¼ ë¹„í™œì„±í™”
      document.querySelectorAll('.choice-btn').forEach(b => { b.disabled = true; b.style.opacity = '0.5'; });
      // ì„ íƒí•œ ë²„íŠ¼ ê°•ì¡°
      document.querySelectorAll('.choice-btn').forEach(b => {
        if (parseInt(b.dataset.choice) === choice) { b.style.opacity = '1'; b.style.transform = 'scale(0.95)'; }
      });
    }

    // Socket ì´ë²¤íŠ¸
    socket.on('quiz:room-created', ({ code, playerName, playerId: pid }) => {
      playerId = pid;
      localStorage.setItem('quiz-player-id', pid);
      localStorage.setItem('quiz-room-code', code);
      localStorage.setItem('quiz-player-name', playerName);
      isHost = true;
      document.getElementById('display-code').textContent = code;
      showScreen('screen-waiting');
    });

    socket.on('quiz:room-joined', ({ code, playerName, playerId: pid, isHost: host }) => {
      playerId = pid;
      localStorage.setItem('quiz-player-id', pid);
      localStorage.setItem('quiz-room-code', code);
      localStorage.setItem('quiz-player-name', playerName);
      isHost = host;
      document.getElementById('display-code').textContent = code;
      showScreen('screen-waiting');
    });

    socket.on('quiz:player-list', ({ players, code, difficulty, totalRounds: tr }) => {
      totalRounds = tr;
      const list = document.getElementById('player-list');
      list.innerHTML = '';
      let connectedCount = 0;
      players.forEach(p => {
        if (p.connected) connectedCount++;
        list.innerHTML += `<div class="player-card" style="opacity:${p.connected ? 1 : 0.4}">
          <span class="p-emoji">${p.emoji}</span>
          <span class="p-name">${escHtml(p.name)}</span>
          ${p.isHost ? '<span class="p-host">ğŸ‘‘ ë°©ì¥</span>' : ''}
          ${!p.connected ? '<span style="color:#888;font-size:0.8rem">(ëŠê¹€)</span>' : ''}
        </div>`;
      });

      if (isHost) {
        document.getElementById('difficulty-host').style.display = 'block';
        document.getElementById('rounds-host').style.display = 'block';
        document.getElementById('settings-guest').style.display = 'none';
        document.querySelectorAll('[data-diff]').forEach(b => b.classList.toggle('active', b.dataset.diff === difficulty));
        document.querySelectorAll('[data-rounds]').forEach(b => b.classList.toggle('active', parseInt(b.dataset.rounds) === tr));
      } else {
        document.getElementById('difficulty-host').style.display = 'none';
        document.getElementById('rounds-host').style.display = 'none';
        document.getElementById('settings-guest').style.display = 'block';
        document.getElementById('settings-guest').textContent = `ë‚œì´ë„: ${DIFF_LABELS[difficulty] || difficulty} | ${tr}ë¼ìš´ë“œ`;
      }

      const btnStart = document.getElementById('btn-start');
      const waitMsg = document.getElementById('waiting-msg');
      if (isHost && connectedCount >= 2) { btnStart.style.display = 'block'; waitMsg.style.display = 'none'; }
      else if (isHost) { btnStart.style.display = 'none'; waitMsg.textContent = 'ë‹¤ë¥¸ í”Œë ˆì´ì–´ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...'; waitMsg.style.display = 'block'; }
      else { btnStart.style.display = 'none'; waitMsg.textContent = 'ë°©ì¥ì´ ê²Œì„ì„ ì‹œì‘í•  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...'; waitMsg.style.display = 'block'; }
    });

    socket.on('quiz:difficulty-updated', (d) => {
      document.querySelectorAll('[data-diff]').forEach(b => b.classList.toggle('active', b.dataset.diff === d));
      showToast(`ë‚œì´ë„ê°€ ${DIFF_LABELS[d]}ë¡œ ë³€ê²½ë˜ì—ˆì–´ìš”!`);
    });

    socket.on('quiz:rounds-updated', (r) => {
      totalRounds = r;
      document.querySelectorAll('[data-rounds]').forEach(b => b.classList.toggle('active', parseInt(b.dataset.rounds) === r));
      showToast(`${r}ë¼ìš´ë“œë¡œ ë³€ê²½ë˜ì—ˆì–´ìš”!`);
    });

    socket.on('quiz:countdown', (num) => {
      showScreen('screen-countdown');
      document.getElementById('countdown-num').textContent = num;
    });

    socket.on('quiz:game-started', (data) => {
      gameActive = true;
      currentPlayers = data.players;
      totalRounds = data.totalRounds;
      myAnswer = null;
      showScreen('screen-game');
      renderScoreboard(data.players);
      renderProblem(data.problem, data.currentRound, data.totalRounds);
    });

    socket.on('quiz:next-problem', (data) => {
      myAnswer = null;
      currentPlayers = data.players;
      renderScoreboard(data.players);
      renderProblem(data.problem, data.currentRound, totalRounds);
      document.getElementById('problem-area').style.display = 'flex';
      document.getElementById('round-result').style.display = 'none';
      document.getElementById('waiting-answer').style.display = 'none';
    });

    socket.on('quiz:round-result', (data) => {
      currentPlayers = data.players;
      renderScoreboard(data.players);
      document.getElementById('round-indicator').textContent = `${data.currentRound} / ${data.totalRounds} ë¼ìš´ë“œ`;

      // ê²°ê³¼ í‘œì‹œ
      document.getElementById('problem-area').style.display = 'none';
      const resultDiv = document.getElementById('round-result');
      resultDiv.style.display = 'flex';

      const prob = data.problem;
      const opSymbol = prob.op === '+' ? 'ï¼‹' : 'ï¼';
      let resultHtml = `<div class="result-answer">${prob.a} ${opSymbol} ${prob.b} ï¼ <span style="font-weight:900;color:var(--green)">${prob.answer}</span></div>`;

      if (data.roundWinner) {
        resultHtml += `<div class="result-winner">${data.roundWinner.emoji}</div>`;
        resultHtml += `<div class="result-winner-name">${escHtml(data.roundWinner.name)} ì •ë‹µ! ğŸ‰</div>`;
        playCorrect();
      } else {
        resultHtml += `<div style="font-size:1.2rem;font-weight:700;color:var(--accent);margin:12px 0;">ì•„ë¬´ë„ ëª» ë§ì·„ì–´ìš”! ğŸ˜…</div>`;
      }

      // ê° í”Œë ˆì´ì–´ ë‹µë³€
      resultHtml += '<div style="margin-top:12px;">';
      for (const [pid, ans] of Object.entries(data.answers)) {
        const icon = ans.correct ? 'âœ…' : 'âŒ';
        const color = ans.correct ? 'var(--green)' : 'var(--accent)';
        resultHtml += `<div class="result-player-answer"><span>${escHtml(ans.name)}:</span> <span style="font-weight:700;color:${color}">${ans.choice} ${icon}</span></div>`;
      }
      resultHtml += '</div>';

      document.getElementById('result-box').innerHTML = resultHtml;

      // ë‹¤ìŒ ë²„íŠ¼
      if (isHost) {
        const btnNext = document.getElementById('btn-next');
        btnNext.style.display = 'block';
        btnNext.textContent = data.currentRound >= data.totalRounds ? 'ğŸ† ê²°ê³¼ ë³´ê¸°' : 'ë‹¤ìŒ ë¬¸ì œ â¡ï¸';
        document.getElementById('waiting-next').style.display = 'none';
      } else {
        document.getElementById('btn-next').style.display = 'none';
        document.getElementById('waiting-next').style.display = 'block';
      }
    });

    socket.on('quiz:game-finished', (data) => {
      gameActive = false;
      playFanfare();
      showScreen('screen-result');

      const list = document.getElementById('final-list');
      list.innerHTML = '';
      const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
      data.players.forEach((p, i) => {
        const isWinner = i === 0;
        list.innerHTML += `<div class="final-card ${isWinner ? 'winner' : ''}">
          <span class="final-medal">${medals[i] || ''}</span>
          <span class="final-emoji">${p.emoji}</span>
          <div class="final-info">
            <div class="final-name">${escHtml(p.name)}</div>
            <div class="final-detail">${p.score} / ${totalRounds} ì •ë‹µ</div>
          </div>
          <div class="final-score" style="color:${isWinner ? 'var(--gold)' : '#888'}">${p.score}</div>
        </div>`;
      });

      document.getElementById('btn-play-again').style.display = (data.isHost || isHost) ? 'block' : 'none';
    });

    socket.on('quiz:game-reset', () => {
      gameActive = false; myAnswer = null;
      showScreen('screen-waiting');
    });

    socket.on('quiz:game-restored', (data) => {
      isHost = data.isHost;
      currentPlayers = data.players;
      gameActive = true;
      showScreen('screen-game');
      renderScoreboard(data.players);

      if (data.status === 'playing') {
        myAnswer = data.myAnswer ? data.myAnswer.choice : null;
        renderProblem(data.currentProblem, data.currentRound, data.totalRounds);
        document.getElementById('problem-area').style.display = 'flex';
        document.getElementById('round-result').style.display = 'none';
        if (myAnswer !== null) document.getElementById('waiting-answer').style.display = 'block';
      } else if (data.status === 'roundResult') {
        // ë¼ìš´ë“œ ê²°ê³¼ ìƒíƒœë¡œ ë³µì› - ë‹¤ìŒ ë¬¸ì œ ëŒ€ê¸°
        document.getElementById('problem-area').style.display = 'none';
        document.getElementById('round-result').style.display = 'flex';
        document.getElementById('result-box').innerHTML = '<p style="color:#888">ë¼ìš´ë“œ ê²°ê³¼ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</p>';
        if (isHost) { document.getElementById('btn-next').style.display = 'block'; document.getElementById('waiting-next').style.display = 'none'; }
        else { document.getElementById('btn-next').style.display = 'none'; document.getElementById('waiting-next').style.display = 'block'; }
      }
      showToast('ê²Œì„ì— ë‹¤ì‹œ ì ‘ì†í–ˆì–´ìš”!');
    });

    socket.on('quiz:player-disconnected', ({ name }) => { showToast(`${name} ë‹˜ì˜ ì—°ê²°ì´ ëŠê²¼ì–´ìš”`); });
    socket.on('quiz:error-msg', (msg) => { showToast(msg); });

    // ë Œë”ë§
    function renderScoreboard(players) {
      const el = document.getElementById('scoreboard');
      el.innerHTML = '';
      players.forEach(p => {
        el.innerHTML += `<div class="score-item">
          <span class="score-emoji">${p.emoji}</span>
          <span class="score-name">${escHtml(p.name)}</span>
          <span class="score-pts">${p.score}</span>
        </div>`;
      });
    }

    function renderProblem(problem, round, total) {
      document.getElementById('round-indicator').textContent = `${round} / ${total} ë¼ìš´ë“œ`;
      const opSymbol = problem.op === '+' ? 'ï¼‹' : 'ï¼';
      document.getElementById('problem-box').innerHTML =
        `<span class="problem-num">${problem.a}</span>
         <span class="problem-op">${opSymbol}</span>
         <span class="problem-num">${problem.b}</span>
         <span class="problem-op">ï¼</span>
         <span class="problem-num">?</span>`;

      const grid = document.getElementById('choices-grid');
      grid.innerHTML = '';
      problem.choices.forEach((c, i) => {
        const btn = document.createElement('button');
        btn.className = 'choice-btn';
        btn.style.background = CHOICE_COLORS[i % CHOICE_COLORS.length];
        btn.textContent = c;
        btn.dataset.choice = c;
        btn.onclick = () => submitAnswer(c);
        if (myAnswer !== null) {
          btn.disabled = true;
          btn.style.opacity = '0.5';
          if (c === myAnswer) { btn.style.opacity = '1'; btn.style.transform = 'scale(0.95)'; }
        }
        grid.appendChild(btn);
      });

      document.getElementById('waiting-answer').style.display = myAnswer !== null ? 'block' : 'none';
    }

    // ìë™ ì¬ì ‘ì†
    window.addEventListener('load', () => {
      if (playerId && savedRoomCode && savedPlayerName) {
        getAudioCtx();
        socket.emit('quiz:join-room', {
          code: savedRoomCode, playerName: savedPlayerName, playerId, emoji: selectedEmoji,
        });
      }
    });

    // ìƒˆë¡œê³ ì¹¨ ë°©ì§€
    document.addEventListener('keydown', (e) => {
      if ((e.key === 'F5' || (e.ctrlKey && (e.key === 'r' || e.key === 'R'))) && gameActive) {
        e.preventDefault(); showToast('ê²Œì„ ì¤‘ì—ëŠ” ìƒˆë¡œê³ ì¹¨í•  ìˆ˜ ì—†ì–´ìš”!');
      }
    });
    window.addEventListener('beforeunload', (e) => { if (gameActive) { e.preventDefault(); e.returnValue = ''; } });

    // ì—”í„°í‚¤
    document.getElementById('input-code').addEventListener('keydown', (e) => { if (e.key === 'Enter') joinRoom(); });
    document.getElementById('input-name').addEventListener('keydown', (e) => { if (e.key === 'Enter') document.getElementById('input-code').focus(); });
  </script>
</body>
</html>
