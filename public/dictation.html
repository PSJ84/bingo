<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ë°›ì•„ì“°ê¸° ì—°ìŠµ</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#1a1a2e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="/icons/icon-192.svg">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #1a1a2e; --card: #16213e; --accent: #e94560; --accent2: #0f3460;
      --gold: #f5c518; --text: #eee; --green: #4ecca3; --orange: #ff9f43; --purple: #6c5ce7;
    }
    body {
      font-family: 'Segoe UI', 'Apple SD Gothic Neo', sans-serif;
      background: var(--bg); color: var(--text);
      min-height: 100dvh; display: flex; flex-direction: column; align-items: center;
    }
    h1 { font-size: 1.8rem; margin: 16px 0 8px; text-align: center; }
    .sub-text { color: #888; font-size: 0.85rem; margin: 4px 0; }
    .screen { display: none; width: 100%; max-width: 500px; padding: 16px; }
    .screen.active { display: flex; flex-direction: column; align-items: center; }
    .back-btn {
      background: none; border: 1px solid #555; color: #aaa;
      padding: 8px 20px; border-radius: 8px; cursor: pointer; font-size: 0.9rem;
      margin: 8px 0; text-decoration: none; display: inline-block; text-align: center;
    }
    .stage-list { width: 100%; max-width: 360px; display: flex; flex-direction: column; gap: 10px; margin: 12px 0; }
    .stage-card {
      display: flex; align-items: center; gap: 14px; padding: 16px 18px;
      background: var(--card); border-radius: 16px; cursor: pointer;
      border: 2px solid #333; transition: all 0.15s;
    }
    .stage-card:hover { border-color: var(--gold); transform: scale(1.02); }
    .stage-card:active { transform: scale(0.97); }
    .stage-card.locked { opacity: 0.4; pointer-events: none; }
    .stage-num {
      width: 44px; height: 44px; border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.3rem; font-weight: 900; flex-shrink: 0;
    }
    .stage-info { flex: 1; }
    .stage-title { font-weight: 700; font-size: 1rem; margin-bottom: 2px; }
    .stage-desc { font-size: 0.78rem; color: #888; }
    .progress-bar { height: 4px; background: #333; border-radius: 2px; overflow: hidden; margin-top: 4px; }
    .progress-fill { height: 100%; background: var(--gold); border-radius: 2px; }
    .stage-stars { font-size: 0.75rem; color: var(--gold); margin-top: 2px; }

    .problem-header {
      width: 100%; display: flex; justify-content: space-between; align-items: center;
      padding: 8px 0; margin-bottom: 8px;
    }
    .problem-counter { font-size: 0.9rem; color: #888; font-weight: 700; }

    /* ëª¨ë“œ ì „í™˜ */
    .mode-toggle {
      display: flex; gap: 4px; background: var(--card); border-radius: 10px; padding: 3px; margin: 8px 0;
    }
    .mode-btn {
      padding: 8px 18px; border: none; border-radius: 8px; font-size: 0.9rem; font-weight: 700;
      cursor: pointer; background: transparent; color: #888; transition: all 0.2s;
    }
    .mode-btn.active { background: var(--purple); color: #fff; }

    /* ë“£ê¸° ë²„íŠ¼ */
    .listen-btn {
      width: 100px; height: 100px; border-radius: 50%; border: none;
      background: var(--purple); color: #fff; font-size: 2.5rem;
      cursor: pointer; margin: 12px 0; transition: transform 0.15s;
      box-shadow: 0 4px 15px rgba(108,92,231,0.4);
    }
    .listen-btn:active { transform: scale(0.9); }
    .listen-btn.playing { animation: pulse 0.8s infinite; }
    @keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.08); } }

    .listen-hint { font-size: 0.9rem; color: #888; margin: 4px 0; }

    /* íƒ€ì´í•‘ ëª¨ë“œ */
    .typing-input {
      width: 100%; max-width: 320px; padding: 16px; margin: 12px 0;
      border: 3px solid #444; border-radius: 14px; font-size: 1.5rem;
      font-weight: 700; text-align: center; background: var(--card);
      color: var(--text); outline: none;
    }
    .typing-input:focus { border-color: var(--purple); }

    /* ê·¸ë¦¬ê¸° ëª¨ë“œ */
    .canvas-area {
      width: 100%; display: flex; flex-direction: column; align-items: center; gap: 8px; margin: 12px 0;
    }
    .canvas-row { display: flex; gap: 6px; flex-wrap: wrap; justify-content: center; }
    .char-canvas-wrap {
      display: flex; flex-direction: column; align-items: center; gap: 2px;
    }
    .char-canvas {
      border: 2px solid #444; border-radius: 10px; background: #0d1b2a;
      touch-action: none;
    }
    .char-canvas.active { border-color: var(--purple); }
    .char-label { font-size: 0.7rem; color: #666; }
    .canvas-tools {
      display: flex; gap: 8px; margin-top: 4px;
    }
    .canvas-tool-btn {
      padding: 6px 16px; border: 1px solid #555; border-radius: 8px;
      background: var(--card); color: #aaa; font-size: 0.85rem; cursor: pointer;
    }

    /* ê²°ê³¼ í‘œì‹œ */
    .result-display {
      width: 100%; max-width: 360px; padding: 16px;
      background: rgba(108,92,231,0.1); border-radius: 14px; margin: 8px 0;
      text-align: center;
    }
    .result-char { display: inline-block; font-size: 1.8rem; font-weight: 900; margin: 0 2px; padding: 4px 8px; border-radius: 6px; }
    .result-char.correct { color: var(--green); }
    .result-char.wrong { color: var(--accent); text-decoration: underline; }

    .submit-btn {
      padding: 14px 48px; background: var(--green); color: #000;
      font-weight: 800; font-size: 1.1rem; border: none; border-radius: 14px;
      cursor: pointer; margin: 8px 0;
    }
    .next-btn {
      padding: 14px 40px; background: var(--green); color: #000;
      font-weight: 800; font-size: 1.1rem; border: none; border-radius: 14px;
      cursor: pointer; margin: 8px 0;
    }
    .step-hint { font-size: 0.9rem; color: var(--orange); margin: 6px 0; text-align: center; }

    .feedback-overlay {
      position: fixed; inset: 0; z-index: 100; display: flex; align-items: center; justify-content: center;
      pointer-events: none; animation: feedbackPop 0.8s forwards;
    }
    .feedback-msg {
      font-size: 1.8rem; font-weight: 900; padding: 20px 40px; border-radius: 20px;
      animation: feedbackScale 0.5s ease;
    }
    .feedback-correct { background: rgba(78,204,163,0.95); color: #000; }
    .feedback-wrong { background: rgba(233,69,96,0.95); color: #fff; }
    @keyframes feedbackPop { 0%{opacity:1}70%{opacity:1}100%{opacity:0} }
    @keyframes feedbackScale { 0%{transform:scale(0.5)}50%{transform:scale(1.1)}100%{transform:scale(1)} }

    .complete-emoji { font-size: 4rem; margin: 16px 0; }
    .complete-title { font-size: 1.6rem; font-weight: 900; color: var(--gold); }
    .complete-subtitle { font-size: 1.1rem; color: #ccc; margin: 8px 0 16px; }
    .complete-stars { font-size: 2rem; margin: 8px 0; }
    .complete-btn { padding: 14px 36px; border: none; border-radius: 14px; font-size: 1.1rem; font-weight: 800; cursor: pointer; margin: 6px; }
    .complete-btn.primary { background: var(--green); color: #000; }
    .complete-btn.secondary { background: var(--card); color: var(--text); border: 1px solid #555; }

    .toast {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: var(--accent); color: #fff; padding: 12px 24px; border-radius: 12px;
      font-weight: 600; z-index: 200; animation: toastIn 0.3s, toastOut 0.3s 2s forwards;
    }
    @keyframes toastIn { from { opacity:0; transform:translateX(-50%) translateY(20px); } }
    @keyframes toastOut { to { opacity:0; transform:translateX(-50%) translateY(20px); } }
  </style>
</head>
<body>
  <!-- ë‹¨ê³„ ì„ íƒ -->
  <div id="screen-stages" class="screen active">
    <h1>âœï¸ ë°›ì•„ì“°ê¸°</h1>
    <p class="sub-text">ì†Œë¦¬ë¥¼ ë“£ê³  ë”°ë¼ ì¨ë´ìš”!</p>
    <div class="stage-list" id="stage-list"></div>
    <a href="/" class="back-btn" style="margin-top:8px;">ğŸ  í™ˆìœ¼ë¡œ</a>
  </div>

  <!-- ë¬¸ì œ í’€ì´ -->
  <div id="screen-problem" class="screen">
    <div class="problem-header">
      <button class="back-btn" onclick="backToStages()" style="margin:0;padding:6px 14px;">â† ëª©ë¡</button>
      <span class="problem-counter" id="problem-counter">1 / 10</span>
      <span id="problem-stars" style="font-size:1rem;">â­ 0</span>
    </div>

    <!-- ëª¨ë“œ ì „í™˜ -->
    <div class="mode-toggle">
      <button class="mode-btn active" id="mode-draw" onclick="setMode('draw')">âœï¸ ê·¸ë¦¬ê¸°</button>
      <button class="mode-btn" id="mode-type" onclick="setMode('type')">âŒ¨ï¸ íƒ€ì´í•‘</button>
    </div>

    <!-- ë“£ê¸° ë²„íŠ¼ -->
    <button class="listen-btn" id="btn-listen" onclick="playWord()">ğŸ”Š</button>
    <p class="listen-hint">ë²„íŠ¼ì„ ëˆŒëŸ¬ ë“¤ì–´ë³´ì„¸ìš”</p>

    <!-- ê·¸ë¦¬ê¸° ëª¨ë“œ -->
    <div class="canvas-area" id="draw-area">
      <div class="canvas-row" id="canvas-row"></div>
      <div class="canvas-tools">
        <button class="canvas-tool-btn" onclick="clearCurrentCanvas()">í˜„ì¬ ì¹¸ ì§€ìš°ê¸°</button>
        <button class="canvas-tool-btn" onclick="clearAllCanvas()">ì „ì²´ ì§€ìš°ê¸°</button>
      </div>
    </div>

    <!-- íƒ€ì´í•‘ ëª¨ë“œ -->
    <div id="type-area" style="display:none; width:100%; display:none; flex-direction:column; align-items:center;">
      <input type="text" class="typing-input" id="typing-input" placeholder="ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”" autocomplete="off" autocapitalize="off" spellcheck="false">
    </div>

    <!-- ê²°ê³¼ -->
    <div class="result-display" id="result-display" style="display:none"></div>
    <div id="hint-area" style="display:none" class="step-hint"></div>

    <button class="submit-btn" id="btn-submit" onclick="submitAnswer()">í™•ì¸!</button>
    <button class="next-btn" id="btn-next" style="display:none" onclick="nextProblem()">ë‹¤ìŒ ë¬¸ì œ â†’</button>
  </div>

  <!-- ì™„ë£Œ -->
  <div id="screen-complete" class="screen">
    <div class="complete-emoji" id="complete-emoji">ğŸ†</div>
    <div class="complete-title" id="complete-title">ë‹¨ê³„ í´ë¦¬ì–´!</div>
    <div class="complete-subtitle" id="complete-subtitle"></div>
    <div class="complete-stars" id="complete-stars"></div>
    <div style="display:flex;flex-wrap:wrap;justify-content:center;gap:8px;margin-top:12px;">
      <button class="complete-btn secondary" onclick="backToStages()">ëª©ë¡ìœ¼ë¡œ</button>
      <button class="complete-btn secondary" onclick="retryStage()">ë‹¤ì‹œ í•˜ê¸°</button>
      <button class="complete-btn primary" id="btn-next-stage" onclick="goNextStage()">ë‹¤ìŒ ë‹¨ê³„ â†’</button>
    </div>
  </div>

  <script>
    // â”€â”€ ë‹¨ì–´ ì„¸íŠ¸ â”€â”€
    const WORDS = {
      1: ['ë‚˜ë¬´','ë°”ë‹¤','ìš°ìœ ','ê°€êµ¬','ì•„ê¸°','ì˜¤ì´','ì—¬ìš°','í† ë¼','ë¨¸ë¦¬','í—ˆë¦¬',
          'ë‚˜ë¼','ë‹¤ë¦¬','ê³ ê¸°','ì†Œë¦¬','ë¬´ì§€ê°œ','ê¸°ì°¨','í”¼ì•„ë…¸','í¬ë„','ëª¨ì','êµ¬ë‘',
          'ì´ì•¼ê¸°','í•˜ë§ˆ','ì½”ë¼ë¦¬','ê¸°ëŸ¬ê¸°','ë‘ë¶€','ìˆ˜ë°•','í˜¸ìˆ˜','ë¶€ì±„','ì˜¤ë¦¬','ìë¦¬'],
      2: ['ì‚¬ëŒ','í•™êµ','ê³µì›','ì„ ìƒ','ë™ë¬¼','ì‹ë¬¼','ë§ˆì„','êµ¬ë¦„','ë°”ëŒ','ê°€ì„',
          'ê²¨ìš¸','ë´„ë‚ ','ì‚°ê¸¸','ê°•ë¬¼','ë¬¸í•™','ì—°í•„','ì±…ìƒ','ì˜ì›','ê±´ë¬¼','í¸ì§€',
          'ë†€ì´í„°','ì¹œêµ¬','ë°©í•™','ìš´ë™','ìŒì•…','ìƒ‰ì—°í•„','ì§€ìš°ê°œ','ê°€ë°©','ì˜·ì¥','ì°½ë¬¸'],
      3: ['ì˜ì','ë‹­','ê°’','ì—†ë‹¤','ì½ë‹¤','ë§‘ë‹¤','ì Šë‹¤','ë„“ë‹¤','ì™¸êµ­','ì‰¬ë‹¤',
          'ì–˜ê¸°','ì™œ','ë¼ì§€','ë’¤','ì¥','ê¶¤ë„','í›¼ì†','ì›ë˜','ì˜ì‚¬','íšŒì˜',
          'ì˜ˆì˜ë‹¤','ì“°ë‹¤','ë¹›','ê½ƒ','ìˆ²','ë°­','í™','ì','ì‚¶','ë„‹'],
      4: ['ë‚˜ëŠ” í•™êµì— ê°‘ë‹ˆë‹¤','ì˜¤ëŠ˜ ë‚ ì”¨ê°€ ì¢‹ìŠµë‹ˆë‹¤','ì—„ë§ˆê°€ ë°¥ì„ í•©ë‹ˆë‹¤',
          'ì•„ë¹ ì™€ ê³µì›ì— ê°”ë‹¤','ì¹œêµ¬ì™€ ë†€ì´í„°ì—ì„œ ë†€ì•˜ë‹¤','ìš°ë¦¬ ì§‘ì— ê³ ì–‘ì´ê°€ ìˆë‹¤',
          'ë¹„ê°€ ì™€ì„œ ìš°ì‚°ì„ ì¼ë‹¤','ë™ìƒì´ ì±…ì„ ì½ëŠ”ë‹¤','ì„ ìƒë‹˜ì´ ì´ì•¼ê¸°ë¥¼ í–ˆë‹¤',
          'ê½ƒì´ ì˜ˆì˜ê²Œ í”¼ì—ˆë‹¤','ë‚˜ë¬´ ìœ„ì— ìƒˆê°€ ìˆë‹¤','ë¬¼ì„ ë§ˆì‹œê³  ì‹¶ë‹¤',
          'ë‚´ì¼ì€ ì¼ìš”ì¼ì´ë‹¤','ê°€ì„ì— ë‹¨í’ì´ ë“¤ì—ˆë‹¤','ê²¨ìš¸ì— ëˆˆì´ ì˜¨ë‹¤'],
    };

    const STAGES = [
      { id: 1, title: 'ê¸°ë³¸ ë‚±ë§', desc: 'ë°›ì¹¨ ì—†ëŠ” ì‰¬ìš´ ë‹¨ì–´', icon: 'ğŸ“', color: '#4ecca3' },
      { id: 2, title: 'ë°›ì¹¨ ìˆëŠ” ë‚±ë§', desc: 'ë°›ì¹¨ì´ ìˆëŠ” ë‹¨ì–´', icon: 'âœï¸', color: '#f5c518' },
      { id: 3, title: 'ì–´ë ¤ìš´ ë‚±ë§', desc: 'ì´ì¤‘ëª¨ìŒ, ê²¹ë°›ì¹¨', icon: 'ğŸ“–', color: '#6c5ce7' },
      { id: 4, title: 'ì§§ì€ ë¬¸ì¥', desc: 'ë¬¸ì¥ ë°›ì•„ì“°ê¸°', icon: 'ğŸ“„', color: '#e94560' },
    ];

    const PROBLEMS_PER_SET = 10;
    const UNLOCK_THRESHOLD = 7;
    const ENCOURAGE = ['ì˜í–ˆì–´ìš”! ğŸ‘','ëŒ€ë‹¨í•´ìš”! â­','ë©‹ì ¸ìš”! ğŸ‰','ì •ë‹µì´ì—ìš”! ğŸ˜Š','ìµœê³ ì˜ˆìš”! ğŸ§ ','ì™„ë²½í•´ìš”! ğŸ’¯'];
    const ENCOURAGE_WRONG = ['ê´œì°®ì•„ìš”, ë‹¤ì‹œ í•´ë´ìš”! ğŸ˜Š','ì¡°ê¸ˆë§Œ ë” ìƒê°í•´ë´ìš”! ğŸ¤”','ì²œì²œíˆ í•´ë„ ê´œì°®ì•„ìš” ğŸ’ª'];

    let currentStageId = 0, currentProblemIdx = 0, currentWord = '';
    let attempts = 0, problemStars = 3, sessionStars = 0, sessionCompleted = 0;
    let inputMode = 'draw'; // 'draw' | 'type'
    let canvases = [];
    let activeCanvasIdx = 0;
    let drawingData = []; // stroke data per canvas
    let progress = loadProgress();

    function randInt(a,b) { return Math.floor(Math.random()*(b-a+1))+a; }
    function pick(arr) { return arr[Math.floor(Math.random()*arr.length)]; }
    function shuffle(arr) { for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }

    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    // â”€â”€ íš¨ê³¼ìŒ â”€â”€
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    let audioCtx = null;
    function getAudioCtx() { if(!audioCtx) audioCtx=new AudioCtx(); if(audioCtx.state==='suspended') audioCtx.resume(); return audioCtx; }
    function playCorrectSound() { const ctx=getAudioCtx(),t=ctx.currentTime; [523,659,784].forEach((f,i)=>{const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='sine';o.frequency.setValueAtTime(f,t+i*0.1);g.gain.setValueAtTime(0.25,t+i*0.1);g.gain.exponentialRampToValueAtTime(0.01,t+i*0.1+0.25);o.start(t+i*0.1);o.stop(t+i*0.1+0.25);}); }
    function playWrongSound() { const ctx=getAudioCtx(),t=ctx.currentTime; const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='square';o.frequency.setValueAtTime(200,t);g.gain.setValueAtTime(0.12,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.25);o.start(t);o.stop(t+0.25); }
    function playClearSound() { const ctx=getAudioCtx(),t=ctx.currentTime; [[523,659,784],[587,740,880],[523,659,784,1047]].forEach((chord,ci)=>{chord.forEach(f=>{const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='sine';o.frequency.setValueAtTime(f,t+ci*0.3);g.gain.setValueAtTime(0.12,t+ci*0.3);g.gain.exponentialRampToValueAtTime(0.01,t+ci*0.3+0.5);o.start(t+ci*0.3);o.stop(t+ci*0.3+0.5);});}); }

    // â”€â”€ TTS (Google Cloud Neural2) â”€â”€
    let ttsAudio = null;
    const ttsCache = {};

    async function speakWord(text) {
      const btn = document.getElementById('btn-listen');
      btn.classList.add('playing');

      try {
        // ìºì‹œ í™•ì¸
        let audioSrc = ttsCache[text];
        if (!audioSrc) {
          const res = await fetch('/api/tts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text }),
          });
          if (!res.ok) throw new Error('TTS failed');
          const data = await res.json();
          audioSrc = 'data:audio/mp3;base64,' + data.audioContent;
          ttsCache[text] = audioSrc;
        }

        // ì´ì „ ì¬ìƒ ì¤‘ì§€
        if (ttsAudio) { ttsAudio.pause(); ttsAudio = null; }

        ttsAudio = new Audio(audioSrc);
        ttsAudio.onended = () => btn.classList.remove('playing');
        ttsAudio.onerror = () => btn.classList.remove('playing');
        await ttsAudio.play();
      } catch (e) {
        console.error('TTS error:', e);
        btn.classList.remove('playing');
        // í´ë°±: ë¸Œë¼ìš°ì € ë‚´ì¥ TTS
        if ('speechSynthesis' in window) {
          const utter = new SpeechSynthesisUtterance(text);
          utter.lang = 'ko-KR'; utter.rate = 0.8;
          utter.onend = () => btn.classList.remove('playing');
          speechSynthesis.speak(utter);
        }
      }
    }

    function playWord() {
      getAudioCtx();
      speakWord(currentWord);
    }

    // â”€â”€ ì§„í–‰ë„ â”€â”€
    function loadProgress() {
      try { const d=JSON.parse(localStorage.getItem('dictation-progress')); if(d&&d.stages) return d; } catch(e){}
      return { stages: { 1:{completed:0,stars:0,unlocked:true}, 2:{completed:0,stars:0,unlocked:true}, 3:{completed:0,stars:0,unlocked:false}, 4:{completed:0,stars:0,unlocked:false} } };
    }
    function saveProgress() { localStorage.setItem('dictation-progress', JSON.stringify(progress)); }
    function checkUnlocks() { for(let i=2;i<=4;i++){if(progress.stages[i-1].completed>=UNLOCK_THRESHOLD) progress.stages[i].unlocked=true;} saveProgress(); }

    // â”€â”€ ëª¨ë“œ ì „í™˜ â”€â”€
    function setMode(mode) {
      inputMode = mode;
      document.getElementById('mode-draw').classList.toggle('active', mode === 'draw');
      document.getElementById('mode-type').classList.toggle('active', mode === 'type');
      document.getElementById('draw-area').style.display = mode === 'draw' ? 'flex' : 'none';
      const typeArea = document.getElementById('type-area');
      typeArea.style.display = mode === 'type' ? 'flex' : 'none';
    }

    // â”€â”€ ìº”ë²„ìŠ¤ ê´€ë¦¬ â”€â”€
    function setupCanvases(word) {
      const chars = currentStageId === 4 ? word.split('') : word.split('');
      const row = document.getElementById('canvas-row');
      row.innerHTML = '';
      canvases = [];
      drawingData = [];
      activeCanvasIdx = 0;

      const size = currentStageId === 4 ? 52 : 72;

      chars.forEach((ch, i) => {
        if (ch === ' ') {
          const spacer = document.createElement('div');
          spacer.style.width = '20px';
          row.appendChild(spacer);
          canvases.push(null);
          drawingData.push(null);
          return;
        }
        const wrap = document.createElement('div');
        wrap.className = 'char-canvas-wrap';

        const canvas = document.createElement('canvas');
        canvas.className = 'char-canvas' + (i === 0 ? ' active' : '');
        canvas.width = size; canvas.height = size;
        canvas.dataset.idx = i;

        canvas.addEventListener('pointerdown', (e) => { e.preventDefault(); startDraw(canvas, e); setActiveCanvas(i); });
        canvas.addEventListener('pointermove', (e) => { e.preventDefault(); moveDraw(canvas, e); });
        canvas.addEventListener('pointerup', (e) => { e.preventDefault(); endDraw(canvas); });

        const label = document.createElement('div');
        label.className = 'char-label';
        label.textContent = (i + 1);

        wrap.appendChild(canvas);
        wrap.appendChild(label);
        row.appendChild(wrap);
        canvases.push(canvas);
        drawingData.push({ strokes: [], currentStroke: null });
      });
    }

    function setActiveCanvas(idx) {
      if (canvases[idx] === null) return;
      activeCanvasIdx = idx;
      canvases.forEach((c, i) => { if (c) c.classList.toggle('active', i === idx); });
    }

    let isDrawing = false;
    function startDraw(canvas, e) {
      isDrawing = true;
      const idx = parseInt(canvas.dataset.idx);
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      drawingData[idx].currentStroke = { x: [x], y: [y] };
      const ctx = canvas.getContext('2d');
      ctx.beginPath();
      ctx.moveTo(x, y);
      ctx.strokeStyle = '#fff';
      ctx.lineWidth = 3;
      ctx.lineCap = 'round';
    }

    function moveDraw(canvas, e) {
      if (!isDrawing) return;
      const idx = parseInt(canvas.dataset.idx);
      const data = drawingData[idx];
      if (!data || !data.currentStroke) return;
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      data.currentStroke.x.push(x);
      data.currentStroke.y.push(y);
      const ctx = canvas.getContext('2d');
      ctx.lineTo(x, y);
      ctx.stroke();
    }

    function endDraw(canvas) {
      if (!isDrawing) return;
      isDrawing = false;
      const idx = parseInt(canvas.dataset.idx);
      const data = drawingData[idx];
      if (!data || !data.currentStroke) return;
      data.strokes.push(data.currentStroke);
      data.currentStroke = null;
    }

    function clearCurrentCanvas() {
      const canvas = canvases[activeCanvasIdx];
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawingData[activeCanvasIdx] = { strokes: [], currentStroke: null };
    }

    function clearAllCanvas() {
      canvases.forEach((canvas, i) => {
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawingData[i] = { strokes: [], currentStroke: null };
      });
    }

    // â”€â”€ Google Handwriting API â”€â”€
    async function recognizeChar(idx) {
      const data = drawingData[idx];
      if (!data || data.strokes.length === 0) return '';

      const canvas = canvases[idx];
      const w = canvas.width, h = canvas.height;
      const ink = data.strokes.map(s => [s.x, s.y, []]);

      try {
        const body = JSON.stringify({
          input_type: 0,
          requests: [{
            writing_guide: { writing_area_width: w, writing_area_height: h },
            ink: ink,
            language: 'ko',
          }]
        });

        const res = await fetch('https://inputtools.google.com/request?itc=ko-t-i0-handwrit&app=translate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: body,
        });
        const json = await res.json();
        if (json[0] === 'SUCCESS' && json[1] && json[1][0] && json[1][0][1]) {
          return json[1][0][1][0] || '';
        }
      } catch (e) {
        console.error('Handwriting API error:', e);
      }
      return '';
    }

    // â”€â”€ ë‹¨ê³„ ì„ íƒ â”€â”€
    function renderStageSelect() {
      checkUnlocks();
      const list = document.getElementById('stage-list');
      list.innerHTML = '';
      STAGES.forEach(s => {
        const p = progress.stages[s.id];
        const pct = Math.min(100, Math.round((p.completed/PROBLEMS_PER_SET)*100));
        const locked = !p.unlocked;
        const card = document.createElement('div');
        card.className = 'stage-card' + (locked ? ' locked' : '');
        card.innerHTML = `
          <div class="stage-num" style="background:${s.color}20;color:${s.color};">${s.icon}</div>
          <div class="stage-info">
            <div class="stage-title">${s.title}</div>
            <div class="stage-desc">${s.desc}</div>
            <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
            <div class="stage-stars">${p.stars>0?'â­ '+p.stars:''} ${p.completed>0?p.completed+'/'+PROBLEMS_PER_SET+' ì™„ë£Œ':''}</div>
          </div>
          ${locked?'<span style="color:#555;font-size:1.2rem;">ğŸ”’</span>':'<span style="color:#555;font-size:1.2rem;">â†’</span>'}`;
        if (!locked) card.onclick = () => startStage(s.id);
        list.appendChild(card);
      });
    }

    // â”€â”€ ê²Œì„ í”Œë¡œìš° â”€â”€
    let wordPool = [];

    function startStage(stageId) {
      getAudioCtx();
      currentStageId = stageId;
      currentProblemIdx = 0;
      sessionStars = 0; sessionCompleted = 0;
      wordPool = shuffle([...WORDS[stageId]]);
      showScreen('screen-problem');
      setMode(inputMode);
      loadProblem();
    }

    function loadProblem() {
      if (wordPool.length === 0) wordPool = shuffle([...WORDS[currentStageId]]);
      currentWord = wordPool.pop();
      attempts = 0; problemStars = 3;

      document.getElementById('problem-counter').textContent = `${currentProblemIdx+1} / ${PROBLEMS_PER_SET}`;
      document.getElementById('problem-stars').textContent = 'â­ ' + sessionStars;
      document.getElementById('result-display').style.display = 'none';
      document.getElementById('hint-area').style.display = 'none';
      document.getElementById('btn-submit').style.display = '';
      document.getElementById('btn-next').style.display = 'none';

      if (inputMode === 'draw') {
        setupCanvases(currentWord);
      } else {
        document.getElementById('typing-input').value = '';
        document.getElementById('typing-input').focus();
      }

      // ìë™ ì½ì–´ì£¼ê¸°
      setTimeout(() => speakWord(currentWord), 300);
    }

    async function submitAnswer() {
      getAudioCtx();
      let userAnswer = '';

      if (inputMode === 'type') {
        userAnswer = document.getElementById('typing-input').value.trim();
      } else {
        // ê·¸ë¦¬ê¸° ëª¨ë“œ: ê° ìº”ë²„ìŠ¤ ì¸ì‹
        const chars = [];
        for (let i = 0; i < canvases.length; i++) {
          if (canvases[i] === null) {
            chars.push(' ');
            continue;
          }
          if (drawingData[i].strokes.length === 0) {
            chars.push('');
            continue;
          }
          const recognized = await recognizeChar(i);
          chars.push(recognized);
        }
        userAnswer = chars.join('');
      }

      if (!userAnswer) {
        showFeedback(false, 'ë‹µì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
        return;
      }

      // ì±„ì 
      const correct = userAnswer === currentWord;
      const resultEl = document.getElementById('result-display');
      resultEl.style.display = 'block';

      if (correct) {
        playCorrectSound();
        sessionStars += problemStars;
        sessionCompleted++;
        currentProblemIdx++;

        showFeedback(true, pick(ENCOURAGE));
        resultEl.innerHTML = `<div style="font-size:1.4rem;font-weight:700;color:var(--green);margin-bottom:8px;">${pick(ENCOURAGE)}</div>` +
          currentWord.split('').map(c => `<span class="result-char correct">${c}</span>`).join('') +
          (problemStars > 0 ? '<br>â­'.repeat(problemStars) : '');

        document.getElementById('problem-stars').textContent = 'â­ ' + sessionStars;
        document.getElementById('btn-submit').style.display = 'none';
        if (currentProblemIdx >= PROBLEMS_PER_SET) {
          setTimeout(() => completeStage(), 1000);
        } else {
          document.getElementById('btn-next').style.display = '';
        }
      } else {
        attempts++;
        playWrongSound();
        // ê¸€ìë³„ ë¹„êµ
        const target = currentWord;
        let html = '';
        const maxLen = Math.max(target.length, userAnswer.length);
        for (let i = 0; i < maxLen; i++) {
          const tc = target[i] || '';
          const uc = userAnswer[i] || '';
          if (tc === uc) {
            html += `<span class="result-char correct">${uc}</span>`;
          } else {
            html += `<span class="result-char wrong">${uc || '_'}</span>`;
          }
        }
        resultEl.innerHTML = `<div style="font-size:0.9rem;color:#888;margin-bottom:8px;">ë‚´ê°€ ì“´ ê²ƒ:</div>` + html;
        showFeedback(false, pick(ENCOURAGE_WRONG));

        if (attempts === 1) problemStars = Math.min(problemStars, 2);
        if (attempts >= 2) {
          problemStars = Math.min(problemStars, 1);
          const hint = document.getElementById('hint-area');
          hint.style.display = 'block';
          hint.textContent = `ğŸ’¡ ë‹¤ì‹œ ë“¤ì–´ë³´ê³  ì²œì²œíˆ ì¨ë³´ì„¸ìš”!`;
        }
        if (attempts >= 3) {
          problemStars = 0;
          const hint = document.getElementById('hint-area');
          hint.textContent = `ì •ë‹µ: ${currentWord}`;
          hint.style.display = 'block';
          document.getElementById('btn-submit').style.display = 'none';
          sessionCompleted++;
          currentProblemIdx++;
          if (currentProblemIdx >= PROBLEMS_PER_SET) {
            setTimeout(() => completeStage(), 1500);
          } else {
            document.getElementById('btn-next').style.display = '';
          }
        }
      }
    }

    function nextProblem() {
      document.getElementById('btn-next').style.display = 'none';
      loadProblem();
    }

    function completeStage() {
      const p = progress.stages[currentStageId];
      p.completed = Math.max(p.completed, sessionCompleted);
      p.stars = Math.max(p.stars, sessionStars);
      checkUnlocks(); saveProgress();
      playClearSound();
      showScreen('screen-complete');
      document.getElementById('complete-emoji').textContent = pick(['ğŸ†','ğŸ‰','ğŸ¥³','â­','ğŸ‘‘']);
      document.getElementById('complete-title').textContent = `${STAGES[currentStageId-1].title} í´ë¦¬ì–´!`;
      document.getElementById('complete-subtitle').textContent = `${sessionCompleted}ë¬¸ì œ ì™„ë£Œ!`;
      document.getElementById('complete-stars').textContent = 'â­ ' + sessionStars + 'ê°œ íšë“!';
      const nextBtn = document.getElementById('btn-next-stage');
      nextBtn.style.display = (currentStageId<4 && progress.stages[currentStageId+1] && progress.stages[currentStageId+1].unlocked) ? 'inline-block' : 'none';
    }

    function backToStages() { showScreen('screen-stages'); renderStageSelect(); }
    function retryStage() { startStage(currentStageId); }
    function goNextStage() { if (currentStageId < 4) startStage(currentStageId + 1); }

    function showFeedback(correct, msg) {
      const overlay = document.createElement('div');
      overlay.className = 'feedback-overlay';
      const m = document.createElement('div');
      m.className = 'feedback-msg ' + (correct ? 'feedback-correct' : 'feedback-wrong');
      m.textContent = msg;
      overlay.appendChild(m);
      document.body.appendChild(overlay);
      setTimeout(() => overlay.remove(), 800);
    }

    // íƒ€ì´í•‘ ì—”í„°í‚¤
    document.getElementById('typing-input').addEventListener('keydown', e => { if (e.key === 'Enter') submitAnswer(); });

    renderStageSelect();
  </script>
</body>
</html>
