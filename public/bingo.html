<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ê°€ì¡± ë¹™ê³  ê²Œì„</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#1a1a2e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="/icons/icon-192.svg">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #1a1a2e;
      --card: #16213e;
      --accent: #e94560;
      --accent2: #0f3460;
      --gold: #f5c518;
      --text: #eee;
      --green: #4ecca3;
    }

    body {
      font-family: 'Segoe UI', 'Apple SD Gothic Neo', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow-x: hidden;
    }

    h1 {
      font-size: 1.8rem;
      margin: 16px 0 8px;
      text-align: center;
    }
    h1 .emoji { font-size: 2rem; }

    /* â”€â”€ ë¡œë¹„ â”€â”€ */
    .screen { display: none; width: 100%; max-width: 500px; padding: 16px; }
    .screen.active { display: flex; flex-direction: column; align-items: center; }

    .lobby-btn {
      width: 100%;
      max-width: 320px;
      padding: 18px;
      margin: 8px 0;
      border: none;
      border-radius: 16px;
      font-size: 1.2rem;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .lobby-btn:active { transform: scale(0.96); }
    .btn-create { background: var(--accent); color: #fff; }
    .btn-join { background: var(--accent2); color: #fff; }

    input[type="text"] {
      width: 100%;
      max-width: 320px;
      padding: 14px;
      margin: 8px 0;
      border: 2px solid #333;
      border-radius: 12px;
      font-size: 1.1rem;
      text-align: center;
      background: #0d1b2a;
      color: #fff;
      outline: none;
    }
    input[type="text"]:focus { border-color: var(--accent); }
    input[type="text"]::placeholder { color: #666; }

    /* â”€â”€ ëŒ€ê¸°ì‹¤ â”€â”€ */
    .room-code {
      font-size: 2.5rem;
      font-weight: 900;
      letter-spacing: 8px;
      color: var(--gold);
      background: rgba(245, 197, 24, 0.1);
      padding: 12px 32px;
      border-radius: 16px;
      margin: 12px 0;
    }

    .player-list {
      list-style: none;
      width: 100%;
      max-width: 320px;
    }
    .player-list li {
      padding: 12px 16px;
      margin: 4px 0;
      background: var(--card);
      border-radius: 10px;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .player-list li.disconnected { opacity: 0.4; }
    .player-list .crown::before { content: '\uD83D\uDC51'; }
    .player-list .member::before { content: '\uD83C\uDFAE'; }

    .btn-start {
      margin-top: 16px;
      padding: 16px 48px;
      background: var(--green);
      color: #000;
      font-weight: 800;
      font-size: 1.2rem;
      border: none;
      border-radius: 14px;
      cursor: pointer;
    }
    .btn-start:active { transform: scale(0.96); }

    .info-text {
      color: #888;
      font-size: 0.95rem;
      margin: 8px 0;
      text-align: center;
    }

    /* â”€â”€ ìŠ¹ë¦¬ ì¤„ ìˆ˜ ì„ íƒ â”€â”€ */
    .wl-selector {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin: 8px 0;
    }
    .wl-btn {
      padding: 10px 18px;
      border: 2px solid #333;
      border-radius: 10px;
      background: var(--card);
      color: var(--text);
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
    }
    .wl-btn.active {
      border-color: var(--gold);
      background: rgba(245, 197, 24, 0.15);
      color: var(--gold);
    }
    .wl-btn:active { transform: scale(0.95); }

    .nr-btn {
      padding: 10px 18px;
      border: 2px solid #333;
      border-radius: 10px;
      background: var(--card);
      color: var(--text);
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
    }
    .nr-btn.active {
      border-color: var(--green);
      background: rgba(78, 204, 163, 0.15);
      color: var(--green);
    }
    .nr-btn:active { transform: scale(0.95); }

    /* â”€â”€ ë­í‚¹ â”€â”€ */
    .ranking-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: var(--card);
      border-radius: 8px;
      margin: 4px 0;
      font-size: 0.95rem;
    }
    .ranking-item .rank-name { flex: 1; }
    .ranking-item .rank-stats { color: var(--gold); font-weight: 700; }
    .ranking-item .rank-streak { color: var(--accent); font-size: 0.8rem; margin-left: 8px; }

    /* â”€â”€ ê²Œì„ í™”ë©´ â”€â”€ */
    .game-header {
      width: 100%;
      max-width: 500px;
      text-align: center;
      padding: 8px;
    }

    .turn-indicator {
      font-size: 1.15rem;
      font-weight: 700;
      padding: 10px;
      border-radius: 12px;
      margin: 6px 0;
      transition: background 0.3s;
    }
    .turn-mine {
      background: var(--accent);
      animation: pulse 1s infinite;
    }
    .turn-other { background: var(--accent2); }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .called-numbers {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: center;
      margin: 8px 0;
      min-height: 36px;
    }
    .called-num {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      background: var(--accent2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.85rem;
    }
    .called-num.latest {
      background: var(--accent);
      transform: scale(1.2);
    }

    .scoreboard {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin: 8px 0;
      flex-wrap: wrap;
    }
    .score-card {
      background: var(--card);
      padding: 8px 16px;
      border-radius: 10px;
      text-align: center;
      min-width: 80px;
    }
    .score-card.me { border: 2px solid var(--gold); }
    .score-card.disconnected { opacity: 0.4; }
    .score-name { font-size: 0.85rem; color: #aaa; }
    .score-lines { font-size: 1.4rem; font-weight: 800; color: var(--gold); }
    .score-label { font-size: 0.7rem; color: #888; }

    /* â”€â”€ ë¹™ê³ íŒ â”€â”€ */
    .board-container {
      width: 100%;
      max-width: 400px;
      padding: 8px;
    }

    .bingo-board {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 6px;
      width: 100%;
      aspect-ratio: 1;
    }

    .cell {
      aspect-ratio: 1;
      border: none;
      border-radius: 12px;
      font-size: 1.6rem;
      font-weight: 800;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--card);
      color: var(--text);
      position: relative;
      -webkit-tap-highlight-color: transparent;
    }

    .cell.marked {
      background: var(--accent);
      color: #fff;
      transform: scale(0.92);
    }
    .cell.bingo-line {
      background: var(--gold);
      color: #000;
      box-shadow: 0 0 12px rgba(245, 197, 24, 0.5);
    }
    .cell:not(.marked):not([disabled]):hover {
      background: #1e3a5f;
    }
    .cell:not(.marked):not([disabled]):active {
      transform: scale(0.9);
    }
    .cell[disabled] {
      cursor: default;
    }

    /* â”€â”€ ìŠ¹ë¦¬ ëª¨ë‹¬ â”€â”€ */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.active { display: flex; }

    .modal {
      background: var(--card);
      border-radius: 24px;
      padding: 32px;
      text-align: center;
      max-width: 360px;
      width: 90%;
      animation: modalPop 0.4s ease;
    }
    @keyframes modalPop {
      0% { transform: scale(0.5); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
    .modal .winner-emoji { font-size: 4rem; margin-bottom: 12px; }
    .modal .winner-name {
      font-size: 1.8rem;
      font-weight: 900;
      color: var(--gold);
      margin-bottom: 8px;
    }
    .modal .winner-msg { font-size: 1.1rem; color: #ccc; margin-bottom: 20px; }
    .btn-new-game {
      padding: 14px 40px;
      background: var(--green);
      color: #000;
      font-weight: 800;
      font-size: 1.1rem;
      border: none;
      border-radius: 14px;
      cursor: pointer;
    }

    /* â”€â”€ í† ìŠ¤íŠ¸ â”€â”€ */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--accent);
      color: #fff;
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 600;
      z-index: 200;
      animation: toastIn 0.3s, toastOut 0.3s 2s forwards;
    }
    @keyframes toastIn { from { opacity: 0; transform: translateX(-50%) translateY(20px); } }
    @keyframes toastOut { to { opacity: 0; transform: translateX(-50%) translateY(20px); } }

    /* â”€â”€ ë°˜ì‘í˜• â”€â”€ */
    @media (max-width: 360px) {
      .cell { font-size: 1.3rem; border-radius: 8px; }
      .bingo-board { gap: 4px; }
      h1 { font-size: 1.4rem; }
    }

    .sub-text { color: #888; font-size: 0.85rem; margin: 4px 0; }

    .back-btn {
      background: none;
      border: 1px solid #555;
      color: #aaa;
      padding: 8px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      margin: 8px 0;
    }

    .btn-restart {
      background: none;
      border: 1px solid var(--accent);
      color: var(--accent);
      padding: 6px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85rem;
      margin: 4px 0;
    }
  </style>
</head>
<body>

  <!-- ë©”ì¸ ë¡œë¹„ -->
  <div id="screen-lobby" class="screen active">
    <h1><span class="emoji">ğŸ±</span> ê°€ì¡± ë¹™ê³ </h1>
    <p class="sub-text">5x5 ìˆ«ì ë¹™ê³  | í•¨ê»˜ ì¦ê¸°ëŠ” ê°€ì¡± ê²Œì„!</p>

    <input type="text" id="input-name" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="8">

    <button class="lobby-btn btn-create" onclick="createRoom()">
      ğŸ  ë°© ë§Œë“¤ê¸°
    </button>

    <div style="display:flex; gap:8px; width:100%; max-width:320px; align-items:center; margin:4px 0;">
      <input type="text" id="input-code" placeholder="ë°© ì½”ë“œ" maxlength="4"
             style="flex:1; text-transform:uppercase; letter-spacing:4px; font-weight:700;">
      <button class="lobby-btn btn-join" onclick="joinRoom()"
              style="width:auto; flex:0 0 auto; padding:14px 24px;">
        ì°¸ê°€
      </button>
    </div>
  </div>

  <!-- ëŒ€ê¸°ì‹¤ -->
  <div id="screen-waiting" class="screen">
    <h1>ğŸ± ëŒ€ê¸°ì‹¤</h1>
    <p class="info-text">ì•„ë˜ ì½”ë“œë¥¼ ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ì…ë ¥í•˜ì„¸ìš”!</p>
    <div class="room-code" id="display-code">----</div>

    <!-- ìŠ¹ë¦¬ ì¤„ ìˆ˜ ì„ íƒ (ë°©ì¥ìš©) -->
    <div id="win-lines-host" style="display:none; margin:8px 0; text-align:center;">
      <p style="color:#aaa; font-size:0.9rem; margin-bottom:6px;">ìŠ¹ë¦¬ ì¡°ê±´</p>
      <div class="wl-selector">
        <button class="wl-btn" data-lines="2" onclick="setWinLines(2)">2ì¤„</button>
        <button class="wl-btn active" data-lines="3" onclick="setWinLines(3)">3ì¤„</button>
        <button class="wl-btn" data-lines="4" onclick="setWinLines(4)">4ì¤„</button>
        <button class="wl-btn" data-lines="5" onclick="setWinLines(5)">5ì¤„</button>
      </div>
    </div>

    <!-- ìˆ«ì ë²”ìœ„ ì„ íƒ (ë°©ì¥ìš©) -->
    <div id="number-range-host" style="display:none; margin:8px 0; text-align:center;">
      <p style="color:#aaa; font-size:0.9rem; margin-bottom:6px;">ìˆ«ì ë²”ìœ„</p>
      <div class="wl-selector">
        <button class="nr-btn active" data-range="25" onclick="setNumberRange(25)">1~25</button>
        <button class="nr-btn" data-range="50" onclick="setNumberRange(50)">1~50</button>
        <button class="nr-btn" data-range="75" onclick="setNumberRange(75)">1~75</button>
      </div>
    </div>

    <!-- ì„¤ì • í‘œì‹œ (ë¹„ë°©ì¥ìš©) -->
    <p id="settings-guest" class="info-text" style="display:none;">
      ìŠ¹ë¦¬ ì¡°ê±´: <strong id="win-lines-value">3</strong>ì¤„ | ìˆ«ì: <strong id="number-range-value">1~25</strong>
    </p>

    <ul class="player-list" id="player-list"></ul>

    <!-- ë­í‚¹ -->
    <div id="rankings-section" style="display:none; width:100%; max-width:320px; margin-top:12px;">
      <p style="text-align:center; color:#aaa; font-size:0.9rem; margin-bottom:6px;">ğŸ† ë­í‚¹</p>
      <div id="rankings-list"></div>
    </div>

    <button class="btn-start" id="btn-start" style="display:none" onclick="startGame()">
      ê²Œì„ ì‹œì‘! ğŸ‰
    </button>
    <p class="info-text" id="waiting-msg">ë°©ì¥ì´ ê²Œì„ì„ ì‹œì‘í•  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>
    <button class="back-btn" onclick="leaveRoom()">ë‚˜ê°€ê¸°</button>
    <a href="/" class="back-btn" style="display:inline-block; text-decoration:none; text-align:center; margin-top:4px;">ğŸ  í™ˆìœ¼ë¡œ</a>
  </div>

  <!-- ê²Œì„ í™”ë©´ -->
  <div id="screen-game" class="screen">
    <div class="game-header">
      <div class="turn-indicator" id="turn-indicator">ë‚´ ì°¨ë¡€!</div>

      <div class="scoreboard" id="scoreboard"></div>

      <div class="called-numbers" id="called-numbers"></div>

      <button class="btn-restart" id="btn-restart" style="display:none" onclick="restartGame()">
        ê²Œì„ ì¬ì‹œì‘
      </button>
    </div>

    <div class="board-container">
      <div class="bingo-board" id="bingo-board"></div>
    </div>
  </div>

  <!-- ìŠ¹ë¦¬ ëª¨ë‹¬ -->
  <div class="modal-overlay" id="modal-win">
    <div class="modal">
      <div class="winner-emoji" id="win-emoji">ğŸ†</div>
      <div class="winner-name" id="win-name">-</div>
      <div class="winner-msg" id="win-msg">ë¹™ê³ !</div>
      <div id="win-rankings" style="margin:12px 0;"></div>
      <button class="btn-new-game" id="btn-new-game" style="display:none" onclick="newGame()">
        í•œ íŒ ë”! ğŸ²
      </button>
      <button class="back-btn" onclick="closeModal()" style="margin-top:8px;">ë‹«ê¸°</button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    let myBoard = null;
    let myMarked = null;
    let myTurnIndex = -1;
    let currentTurn = 0;
    let turnNames = [];
    let calledNumbers = [];
    let isHost = false;
    let gameActive = false;
    let winLines = 3;
    let numberRange = 25;
    let myPrevBingoLines = 0;

    // â”€â”€ í”Œë ˆì´ì–´ ì‹ë³„ (localStorage) â”€â”€
    let playerId = localStorage.getItem('bingo-player-id') || null;
    let savedRoomCode = localStorage.getItem('bingo-room-code') || null;
    let savedPlayerName = localStorage.getItem('bingo-player-name') || null;

    // â”€â”€ Web Audio API íš¨ê³¼ìŒ â”€â”€
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    let audioCtx = null;

    function getAudioCtx() {
      if (!audioCtx) audioCtx = new AudioCtx();
      if (audioCtx.state === 'suspended') audioCtx.resume();
      return audioCtx;
    }

    function playDing() {
      const ctx = getAudioCtx();
      const t = ctx.currentTime;
      [523, 659].forEach((freq, i) => {
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.type = 'sine';
        osc.frequency.setValueAtTime(freq, t + i * 0.15);
        gain.gain.setValueAtTime(0.3, t + i * 0.15);
        gain.gain.exponentialRampToValueAtTime(0.01, t + i * 0.15 + 0.3);
        osc.start(t + i * 0.15);
        osc.stop(t + i * 0.15 + 0.3);
      });
    }

    function playClick() {
      const ctx = getAudioCtx();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.type = 'square';
      osc.frequency.setValueAtTime(800, ctx.currentTime);
      gain.gain.setValueAtTime(0.15, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.08);
      osc.start(ctx.currentTime);
      osc.stop(ctx.currentTime + 0.08);
    }

    function playBingoLine() {
      const ctx = getAudioCtx();
      const t = ctx.currentTime;
      [523, 659, 784].forEach((freq, i) => {
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.type = 'sine';
        osc.frequency.setValueAtTime(freq, t + i * 0.12);
        gain.gain.setValueAtTime(0.25, t + i * 0.12);
        gain.gain.exponentialRampToValueAtTime(0.01, t + i * 0.12 + 0.3);
        osc.start(t + i * 0.12);
        osc.stop(t + i * 0.12 + 0.3);
      });
    }

    function playFanfare() {
      const ctx = getAudioCtx();
      const t = ctx.currentTime;
      const chords = [
        [523, 659, 784],
        [587, 740, 880],
        [523, 659, 784, 1047],
      ];
      chords.forEach((chord, ci) => {
        chord.forEach(freq => {
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.type = 'sine';
          osc.frequency.setValueAtTime(freq, t + ci * 0.3);
          gain.gain.setValueAtTime(0.15, t + ci * 0.3);
          gain.gain.exponentialRampToValueAtTime(0.01, t + ci * 0.3 + 0.5);
          osc.start(t + ci * 0.3);
          osc.stop(t + ci * 0.3 + 0.5);
        });
      });
    }

    // â”€â”€ í™”ë©´ ì „í™˜ â”€â”€
    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    // â”€â”€ í† ìŠ¤íŠ¸ â”€â”€
    function showToast(msg) {
      const t = document.createElement('div');
      t.className = 'toast';
      t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 2500);
    }

    // â”€â”€ ë¡œë¹„ â”€â”€
    function createRoom() {
      const name = document.getElementById('input-name').value.trim();
      if (!name) { showToast('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }
      getAudioCtx();
      isHost = true;
      socket.emit('create-room', { playerName: name, playerId });
    }

    function joinRoom() {
      const name = document.getElementById('input-name').value.trim();
      const code = document.getElementById('input-code').value.trim().toUpperCase();
      if (!name) { showToast('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }
      if (!code || code.length < 4) { showToast('ë°© ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }
      getAudioCtx();
      socket.emit('join-room', { code, playerName: name, playerId });
    }

    function leaveRoom() {
      localStorage.removeItem('bingo-room-code');
      location.reload();
    }

    function startGame() {
      socket.emit('start-game');
    }

    function newGame() {
      socket.emit('new-game');
      document.getElementById('modal-win').classList.remove('active');
    }

    function closeModal() {
      document.getElementById('modal-win').classList.remove('active');
    }

    function setWinLines(lines) {
      socket.emit('set-win-lines', lines);
    }

    function setNumberRange(range) {
      socket.emit('set-number-range', range);
    }

    function restartGame() {
      if (!isHost) return;
      if (confirm('ì •ë§ ê²Œì„ì„ ì¬ì‹œì‘í•˜ì‹œê² ì–´ìš”?')) {
        socket.emit('new-game');
      }
    }

    // â”€â”€ Socket ì´ë²¤íŠ¸ â”€â”€
    socket.on('room-created', ({ code, playerName, playerId: pid }) => {
      playerId = pid;
      localStorage.setItem('bingo-player-id', pid);
      localStorage.setItem('bingo-room-code', code);
      localStorage.setItem('bingo-player-name', playerName);
      isHost = true;
      document.getElementById('display-code').textContent = code;
      showScreen('screen-waiting');
    });

    socket.on('room-joined', ({ code, playerName, playerId: pid, isHost: host }) => {
      playerId = pid;
      localStorage.setItem('bingo-player-id', pid);
      localStorage.setItem('bingo-room-code', code);
      localStorage.setItem('bingo-player-name', playerName);
      isHost = host;
      document.getElementById('display-code').textContent = code;
      showScreen('screen-waiting');
    });

    socket.on('player-list', ({ players, code, winLines: wl, numberRange: nr, rankings }) => {
      // í”Œë ˆì´ì–´ ëª©ë¡
      const list = document.getElementById('player-list');
      list.innerHTML = '';
      let connectedCount = 0;
      players.forEach(p => {
        if (p.connected) connectedCount++;
        const li = document.createElement('li');
        if (!p.connected) li.classList.add('disconnected');
        li.innerHTML = `<span class="${p.isHost ? 'crown' : 'member'}"></span> ${escHtml(p.name)} ${p.isHost ? '<span style="color:#888;font-size:0.8rem">(ë°©ì¥)</span>' : ''} ${!p.connected ? '<span style="color:#888;font-size:0.8rem">(ëŠê¹€)</span>' : ''}`;
        list.appendChild(li);
      });

      // ì„¤ì • í‘œì‹œ
      winLines = wl;
      numberRange = nr || 25;
      if (isHost) {
        document.getElementById('win-lines-host').style.display = 'block';
        document.getElementById('number-range-host').style.display = 'block';
        document.getElementById('settings-guest').style.display = 'none';
        document.querySelectorAll('.wl-btn').forEach(btn => {
          btn.classList.toggle('active', parseInt(btn.dataset.lines) === wl);
        });
        document.querySelectorAll('.nr-btn').forEach(btn => {
          btn.classList.toggle('active', parseInt(btn.dataset.range) === numberRange);
        });
      } else {
        document.getElementById('win-lines-host').style.display = 'none';
        document.getElementById('number-range-host').style.display = 'none';
        document.getElementById('settings-guest').style.display = 'block';
        document.getElementById('win-lines-value').textContent = wl;
        document.getElementById('number-range-value').textContent = `1~${numberRange}`;
      }

      // ì‹œì‘ ë²„íŠ¼
      const btnStart = document.getElementById('btn-start');
      const waitMsg = document.getElementById('waiting-msg');
      if (isHost && connectedCount >= 2) {
        btnStart.style.display = 'block';
        waitMsg.style.display = 'none';
      } else if (isHost) {
        btnStart.style.display = 'none';
        waitMsg.textContent = 'ë‹¤ë¥¸ í”Œë ˆì´ì–´ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...';
        waitMsg.style.display = 'block';
      } else {
        btnStart.style.display = 'none';
        waitMsg.textContent = 'ë°©ì¥ì´ ê²Œì„ì„ ì‹œì‘í•  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...';
        waitMsg.style.display = 'block';
      }

      // ë­í‚¹
      renderRankings(rankings);
    });

    socket.on('win-lines-updated', (lines) => {
      winLines = lines;
      document.querySelectorAll('.wl-btn').forEach(btn => {
        btn.classList.toggle('active', parseInt(btn.dataset.lines) === lines);
      });
      document.getElementById('win-lines-value').textContent = lines;
      showToast(`ìŠ¹ë¦¬ ì¡°ê±´ì´ ${lines}ì¤„ë¡œ ë³€ê²½ë˜ì—ˆì–´ìš”!`);
    });

    socket.on('number-range-updated', (range) => {
      numberRange = range;
      document.querySelectorAll('.nr-btn').forEach(btn => {
        btn.classList.toggle('active', parseInt(btn.dataset.range) === range);
      });
      document.getElementById('number-range-value').textContent = `1~${range}`;
      showToast(`ìˆ«ì ë²”ìœ„ê°€ 1~${range}ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆì–´ìš”!`);
    });

    socket.on('game-started', ({ board, turnOrder, myTurnIndex: mti, currentTurn: ct, winLines: wl, numberRange: nr, isHost: host }) => {
      myBoard = board;
      myMarked = Array.from({ length: 5 }, () => Array(5).fill(false));
      myTurnIndex = mti;
      currentTurn = ct;
      turnNames = turnOrder;
      calledNumbers = [];
      gameActive = true;
      winLines = wl;
      numberRange = nr || 25;
      isHost = host;
      myPrevBingoLines = 0;

      showScreen('screen-game');
      renderBoard();
      renderTurn();
      renderScoreboard([]);
      document.getElementById('called-numbers').innerHTML = '';
      document.getElementById('btn-restart').style.display = isHost ? 'inline-block' : 'none';

      if (myTurnIndex === 0) {
        playDing();
      }
    });

    socket.on('game-restored', (data) => {
      myBoard = data.board;
      myMarked = data.marked;
      myTurnIndex = data.myTurnIndex;
      currentTurn = data.currentTurn;
      turnNames = data.turnOrder;
      calledNumbers = data.calledNumbers;
      winLines = data.winLines;
      isHost = data.isHost;
      myPrevBingoLines = data.bingoLines;
      gameActive = !data.winner;

      showScreen('screen-game');
      renderBoard();
      renderTurn();
      renderCalledNumbers();
      renderScoreboard(data.playerStates);
      document.getElementById('btn-restart').style.display = isHost ? 'inline-block' : 'none';

      if (data.winner) {
        showWinner(data.winner);
      }

      showToast('ê²Œì„ì— ë‹¤ì‹œ ì ‘ì†í–ˆì–´ìš”!');
    });

    socket.on('number-called', (data) => {
      myMarked = data.myMarked;
      calledNumbers = data.calledNumbers;
      currentTurn = data.currentTurn;

      renderBoard();
      renderTurn();
      renderCalledNumbers();
      renderScoreboard(data.playerStates);

      // ë¹™ê³  ì¤„ ì™„ì„± íš¨ê³¼ìŒ
      if (data.myBingoLines > myPrevBingoLines) {
        playBingoLine();
      }
      myPrevBingoLines = data.myBingoLines;

      // ë‚´ ì°¨ë¡€ ì•Œë¦¼
      if (!data.winner && currentTurn === myTurnIndex) {
        playDing();
      }

      if (data.winner) {
        gameActive = false;
        playFanfare();
        showWinner(data.winner, data.rankings);
      }
    });

    socket.on('turn-updated', ({ currentTurn: ct }) => {
      currentTurn = ct;
      renderTurn();
      renderBoard();
      if (currentTurn === myTurnIndex && gameActive) {
        playDing();
      }
    });

    socket.on('game-reset', () => {
      gameActive = false;
      myPrevBingoLines = 0;
      document.getElementById('modal-win').classList.remove('active');
      showScreen('screen-waiting');
    });

    socket.on('player-disconnected', ({ name }) => {
      showToast(`${name} ë‹˜ì˜ ì—°ê²°ì´ ëŠê²¼ì–´ìš”`);
    });

    socket.on('player-reconnected', ({ name }) => {
      showToast(`${name} ë‹˜ì´ ë‹¤ì‹œ ì ‘ì†í–ˆì–´ìš”!`);
    });

    socket.on('error-msg', (msg) => {
      showToast(msg);
    });

    // â”€â”€ í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì¬ì ‘ì† â”€â”€
    window.addEventListener('load', () => {
      if (playerId && savedRoomCode && savedPlayerName) {
        getAudioCtx();
        socket.emit('join-room', {
          code: savedRoomCode,
          playerName: savedPlayerName,
          playerId,
        });
      }

      // ë’¤ë¡œê°€ê¸° ë°©ì§€
      history.pushState(null, '', location.href);
      window.addEventListener('popstate', () => {
        if (gameActive) {
          history.pushState(null, '', location.href);
          showToast('ê²Œì„ ì¤‘ì—ëŠ” ë’¤ë¡œ ê°ˆ ìˆ˜ ì—†ì–´ìš”!');
        }
      });
    });

    // â”€â”€ ìƒˆë¡œê³ ì¹¨ ë°©ì§€ â”€â”€
    document.addEventListener('keydown', (e) => {
      if (e.key === 'F5' || (e.ctrlKey && (e.key === 'r' || e.key === 'R'))) {
        if (gameActive) {
          e.preventDefault();
          showToast('ê²Œì„ ì¤‘ì—ëŠ” ìƒˆë¡œê³ ì¹¨í•  ìˆ˜ ì—†ì–´ìš”!');
        }
      }
    });

    window.addEventListener('beforeunload', (e) => {
      if (gameActive) {
        e.preventDefault();
        e.returnValue = '';
      }
    });

    // â”€â”€ ë Œë”ë§ â”€â”€
    function renderBoard() {
      const boardEl = document.getElementById('bingo-board');
      boardEl.innerHTML = '';

      const bingoSet = getBingoCells(myMarked);
      const isMyTurn = gameActive && (currentTurn === myTurnIndex);

      for (let r = 0; r < 5; r++) {
        for (let c = 0; c < 5; c++) {
          const btn = document.createElement('button');
          btn.className = 'cell';
          btn.textContent = myBoard[r][c];

          if (myMarked[r][c]) {
            btn.classList.add('marked');
            if (bingoSet.has(`${r},${c}`)) {
              btn.classList.add('bingo-line');
            }
          }

          const num = myBoard[r][c];
          if (!calledNumbers.includes(num) && isMyTurn && gameActive) {
            btn.addEventListener('click', () => callNumber(num));
          } else {
            btn.disabled = true;
          }

          boardEl.appendChild(btn);
        }
      }
    }

    function callNumber(num) {
      if (!gameActive) return;
      playClick();
      socket.emit('call-number', num);
    }

    function renderTurn() {
      const el = document.getElementById('turn-indicator');
      if (!gameActive) {
        el.textContent = 'ê²Œì„ ì¢…ë£Œ';
        el.className = 'turn-indicator turn-other';
        return;
      }
      if (currentTurn === myTurnIndex) {
        el.textContent = 'ğŸ¯ ë‚´ ì°¨ë¡€! ìˆ«ìë¥¼ í„°ì¹˜í•˜ì„¸ìš”!';
        el.className = 'turn-indicator turn-mine';
      } else {
        el.textContent = `â³ ${turnNames[currentTurn]} ë‹˜ ì°¨ë¡€...`;
        el.className = 'turn-indicator turn-other';
      }
    }

    function renderCalledNumbers() {
      const el = document.getElementById('called-numbers');
      el.innerHTML = '';
      calledNumbers.forEach((n, i) => {
        const span = document.createElement('span');
        span.className = 'called-num' + (i === calledNumbers.length - 1 ? ' latest' : '');
        span.textContent = n;
        el.appendChild(span);
      });
    }

    function renderScoreboard(playerStates) {
      const el = document.getElementById('scoreboard');
      if (!playerStates || playerStates.length === 0) {
        el.innerHTML = '';
        turnNames.forEach((name, i) => {
          el.innerHTML += `
            <div class="score-card ${i === myTurnIndex ? 'me' : ''}">
              <div class="score-name">${escHtml(name)}</div>
              <div class="score-lines">0</div>
              <div class="score-label">ì¤„</div>
            </div>`;
        });
        return;
      }
      el.innerHTML = '';
      playerStates.forEach(ps => {
        el.innerHTML += `
          <div class="score-card ${ps.isMe ? 'me' : ''} ${ps.connected === false ? 'disconnected' : ''}">
            <div class="score-name">${escHtml(ps.name)}</div>
            <div class="score-lines">${ps.bingoLines}</div>
            <div class="score-label">ì¤„</div>
          </div>`;
      });
    }

    function renderRankings(rankings) {
      const section = document.getElementById('rankings-section');
      const listEl = document.getElementById('rankings-list');
      if (!rankings || rankings.length === 0) {
        section.style.display = 'none';
        return;
      }
      section.style.display = 'block';
      listEl.innerHTML = '';
      const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
      rankings.forEach((r, i) => {
        const medal = medals[i] || '';
        const streakText = r.currentStreak >= 2 ? `${r.currentStreak}ì—°ìŠ¹!` : '';
        listEl.innerHTML += `
          <div class="ranking-item">
            <span class="rank-name">${medal} ${escHtml(r.name)}</span>
            <span class="rank-stats">${r.wins}ìŠ¹ ${r.losses}íŒ¨</span>
            ${streakText ? `<span class="rank-streak">${streakText}</span>` : ''}
          </div>`;
      });
    }

    function showWinner(winner, rankings) {
      const emojis = ['ğŸ†', 'ğŸ‰', 'ğŸ¥³', 'â­', 'ğŸ‘‘'];
      document.getElementById('win-emoji').textContent = emojis[Math.floor(Math.random() * emojis.length)];
      document.getElementById('win-name').textContent = winner.name;
      document.getElementById('win-msg').textContent = `${winner.lines}ì¤„ ë¹™ê³  ë‹¬ì„±! ì¶•í•˜í•´ìš”!`;

      // ëª¨ë‹¬ ë‚´ ë­í‚¹
      const winRankEl = document.getElementById('win-rankings');
      if (rankings && rankings.length > 0) {
        const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
        winRankEl.innerHTML = '<p style="color:#aaa; font-size:0.85rem; margin-bottom:6px;">í˜„ì¬ ì „ì </p>';
        rankings.forEach((r, i) => {
          const medal = medals[i] || '';
          const streakText = r.currentStreak >= 2 ? ` ${r.currentStreak}ì—°ìŠ¹!` : '';
          winRankEl.innerHTML += `
            <div class="ranking-item">
              <span class="rank-name">${medal} ${escHtml(r.name)}</span>
              <span class="rank-stats">${r.wins}ìŠ¹ ${r.losses}íŒ¨</span>
              ${streakText ? `<span class="rank-streak">${streakText}</span>` : ''}
            </div>`;
        });
      } else {
        winRankEl.innerHTML = '';
      }

      document.getElementById('btn-new-game').style.display = isHost ? 'inline-block' : 'none';
      document.getElementById('modal-win').classList.add('active');
    }

    // ë¹™ê³  ì™„ì„±ëœ ì…€ ì§‘í•© ë°˜í™˜
    function getBingoCells(marked) {
      const cells = new Set();
      for (let r = 0; r < 5; r++) {
        if (marked[r].every(v => v)) {
          for (let c = 0; c < 5; c++) cells.add(`${r},${c}`);
        }
      }
      for (let c = 0; c < 5; c++) {
        let ok = true;
        for (let r = 0; r < 5; r++) { if (!marked[r][c]) { ok = false; break; } }
        if (ok) { for (let r = 0; r < 5; r++) cells.add(`${r},${c}`); }
      }
      let d1 = true, d2 = true;
      for (let i = 0; i < 5; i++) {
        if (!marked[i][i]) d1 = false;
        if (!marked[i][4 - i]) d2 = false;
      }
      if (d1) { for (let i = 0; i < 5; i++) cells.add(`${i},${i}`); }
      if (d2) { for (let i = 0; i < 5; i++) cells.add(`${i},${4 - i}`); }
      return cells;
    }

    function escHtml(s) {
      const d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }

    // ì—”í„°í‚¤ë¡œ ì°¸ê°€
    document.getElementById('input-code').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') joinRoom();
    });
    document.getElementById('input-name').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') document.getElementById('input-code').focus();
    });
  </script>
</body>
</html>
